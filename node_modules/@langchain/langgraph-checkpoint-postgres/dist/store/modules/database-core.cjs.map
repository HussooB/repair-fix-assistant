{"version":3,"file":"database-core.cjs","names":[],"sources":["../../../src/store/modules/database-core.ts"],"sourcesContent":["import pg from \"pg\";\nimport { TTLConfig, IndexConfig } from \"./types.js\";\n\n/**\n * Core database operations and connection management.\n * Shared by all modules to avoid duplication.\n */\nexport class DatabaseCore {\n  public readonly pool: pg.Pool;\n\n  public readonly schema: string;\n\n  public readonly ttlConfig?: TTLConfig;\n\n  public readonly indexConfig?: IndexConfig;\n\n  public readonly textSearchLanguage: string;\n\n  constructor(\n    pool: pg.Pool,\n    schema: string,\n    ttlConfig?: TTLConfig,\n    indexConfig?: IndexConfig,\n    textSearchLanguage?: string\n  ) {\n    this.pool = pool;\n    this.schema = schema;\n    this.ttlConfig = ttlConfig;\n    this.indexConfig = indexConfig;\n    this.textSearchLanguage = textSearchLanguage || \"english\";\n  }\n\n  async withClient<T>(\n    operation: (client: pg.PoolClient) => Promise<T>\n  ): Promise<T> {\n    const client = await this.pool.connect();\n    try {\n      return await operation(client);\n    } finally {\n      client.release();\n    }\n  }\n\n  calculateExpiresAt(ttl?: number): Date | null {\n    const effectiveTtl = ttl ?? this.ttlConfig?.defaultTtl;\n    if (!effectiveTtl) return null;\n    return new Date(Date.now() + effectiveTtl * 60 * 1000);\n  }\n\n  async refreshTtl(\n    client: pg.PoolClient,\n    namespacePath: string,\n    key: string\n  ): Promise<void> {\n    if (!this.ttlConfig?.refreshOnRead) return;\n\n    const expiresAt = this.calculateExpiresAt();\n    if (expiresAt) {\n      await client.query(\n        `\n        UPDATE ${this.schema}.store \n        SET expires_at = $3, updated_at = CURRENT_TIMESTAMP\n        WHERE namespace_path = $1 AND key = $2\n      `,\n        [namespacePath, key, expiresAt]\n      );\n    }\n  }\n}\n"],"mappings":";;;;;;AAOA,IAAa,eAAb,MAA0B;CACxB,AAAgB;CAEhB,AAAgB;CAEhB,AAAgB;CAEhB,AAAgB;CAEhB,AAAgB;CAEhB,YACE,MACA,QACA,WACA,aACA,oBACA;AACA,OAAK,OAAO;AACZ,OAAK,SAAS;AACd,OAAK,YAAY;AACjB,OAAK,cAAc;AACnB,OAAK,qBAAqB,sBAAsB;;CAGlD,MAAM,WACJ,WACY;EACZ,MAAM,SAAS,MAAM,KAAK,KAAK;AAC/B,MAAI;AACF,UAAO,MAAM,UAAU;YACf;AACR,UAAO;;;CAIX,mBAAmB,KAA2B;EAC5C,MAAM,eAAe,OAAO,KAAK,WAAW;AAC5C,MAAI,CAAC,aAAc,QAAO;AAC1B,SAAO,IAAI,KAAK,KAAK,QAAQ,eAAe,KAAK;;CAGnD,MAAM,WACJ,QACA,eACA,KACe;AACf,MAAI,CAAC,KAAK,WAAW,cAAe;EAEpC,MAAM,YAAY,KAAK;AACvB,MAAI,UACF,OAAM,OAAO,MACX;iBACS,KAAK,OAAO;;;SAIrB;GAAC;GAAe;GAAK"}